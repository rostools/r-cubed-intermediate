# Quickly re-arranging data with pivots {#pivots}

```{r setup-06, include=FALSE, eval=FALSE}
# Used this only during writing to run code dependent on previous chapters.
source("R/functions.R")
library(here)
library(fs)
library(tidyverse)
library(vroom)
source_session("03-functions.Rmd")
source_session("04-functionals.Rmd")
source_session("05-dplyr-joins.Rmd")
load(here("data/mmash.rda"))
```

Here we will continue using the *Workflow* block as we cover the fourth block,
"*Work with final data*" in Figure \@ref(fig:diagram-overview-4).

```{r diagram-overview-5, fig.cap="Section of the overall workflow we will be covering.", echo=FALSE}
knitr::include_graphics("images/diagram-overview-4.svg")
```

And your folder and file structure should look like:

```
LearnR3
├── data/
│   ├── mmash.rda
│   └── README.md
├── data-raw/
│   ├── mmash-data.zip
│   ├── mmash/
│   │  ├── user_1
│   │  ├── ...
│   │  └── user_22
│   └── mmash.R
├── doc/
│   ├── README.md
│   └── lesson.Rmd
├── R/
│   ├── functions.R
│   └── README.md
├── .Rbuildignore
├── .gitignore
├── DESCRIPTION
├── LearnR3.Rproj
└── README.md
```

## Learning objectives

1. Using the concept of "pivoting" to arrange data from long to wide and vice versa.

## Setup for the analysis in R Markdown

We now have a working dataset to start doing some simple analyses on in the
R Markdown document. A recommended workflow with R Markdown is to often
"Knit" it and make sure your analysis is reproducible (while on your computer).
So let's first clean it up and start from the beginning again.

Before we do that, make sure to **add and commit** all changes done in `doc/lesson.Rmd`.
By keeping changes in the history, we can go back to look at it anytime.

Then, we'll delete everything from below the `setup` code chunk until the end of the file.
This code chunk should have all the packages listed with `library()` functions.
We'll also add `load()` one right below them so we have access to the newly 
merged dataset:

```r
source(here("R/functions.R"))
load(here("data/mmash.rda"))
```

When everything has been deleted, **add and commit** these changes into the Git history.
Then, we'll "Knit" our R Markdown document into HTML by using the "Knit" button
at the top of the pane or with `Ctrl-Shift-K`. Once it creates the file, it should
either pop up or open in the Viewer pane on the side. 

As we write more R code and do some simple analyses of the data, we are going
to be knitting often. The main reason for this is to ensure that whatever you
are writing and coding will at least be reproducible on your computer, since
R Markdown is designed to ensure the document is reproducible.

For this specific workflow and for checking reproducibility, you should output
to HTML rather than to a Word document. While you can create a Word document by
changing the `output: html_document` to `output: word_document` at the top in
the YAML header, you'd only do this when you need to submit to a journal or
need to email to co-authors for review. The reason is simple: After you generate
the Word document from R Markdown, the Word file opens up and consequently Word
locks the file from further edits. What that means is that every time you generate
the Word document, you have to close it before you can generate it again,
otherwise knitting will fail. This can get annoying very quickly (trust me),
since you don't always remember to close the Word document. If you output to
HTML, this won't be a problem.

## Re-arranging data for easier summarizing

`r details_for_instructors("
Let them read through this section and then walk through it again and explain it
a bit more, making use of the tables and graphs. Doing both reading and listening
again will help reinforce the concept of pivoting, which is usually quite
difficult to grasp for those new to it.
")`

**Take 6 min to read over the sections until it says to stop, and then we'll 
go over it again.**
Now that we have the final dataset to work with, we want to explore it a bit
with some simple descriptive statistics. One extremely useful and powerful tool
to summarizing data is by "pivoting" your data. Pivoting is when
you convert data between longer forms (more rows) and wider forms (more columns).
The [tidyr] package within tidyverse contains two wonderful functions for pivoting:
`pivot_longer()` and `pivot_wider()`. There is a well written documentation
on pivoting in the [tidyr website][tidyr-pivoting] that can explain more about it.
The first thing we'll use, and probably the more commonly used in general,
is `pivot_longer()`. This function is commonly used because entering data in
the wide form is easier and more time efficient than entering data in long form.
For instance, if you were measuring glucose values over time in participants,
you might enter data in like this:

[tidyr]: https://tidyr.tidyverse.org/index.html
[tidyr-pivoting]: https://tidyr.tidyverse.org/articles/pivot.html

```{r table-example-wide, echo=FALSE}
example_wide <- tribble(
    ~person_id, ~glucose_0, ~glucose_30, ~glucose_60,
    1, 5.6, 7.8, 4.5,
    2, 4.7, 9.5, 5.3,
    3, 5.1, 10.2, 4.2
) 

example_wide %>% 
    knitr::kable(caption = "Example of a **wide** dataset that is useful for data entry.",
                 align = "c")
```

However, when it comes time to analyze the data, this wide form is very inefficient
and difficult to computationally and statistically work with. So, we do data
entry in wide and use functions like `pivot_longer()` to get the data ready for
analysis. Figure \@ref(fig:image-pivot-longer) visually shows what happens when
you pivot from wide to long.

```{r image-pivot-longer, fig.cap="Pivot longer in tidyr. New columns are called 'name' and 'value'.", out.width="90%", echo=FALSE}
knitr::include_graphics(here::here("images/pivot-longer.png"))
```

If you had, for instance, an ID column for each participant, the pivoting would 
look like what is shown in Figure \@ref(fig:image-pivot-longer-id).

```{r image-pivot-longer-id, fig.cap="Pivot longer in tidyr, excluding an 'id' column. New columns are called 'name' and 'value', as well as the old 'id' column.", out.width="90%", echo=FALSE}
knitr::include_graphics(here::here("images/pivot-longer-id.png"))
```

Pivoting is a conceptually challenging thing to grasp, so don't be disheartened
if you can't understand how it works yet. As you practice using it, you will
understand it. With `pivot_longer()`, the first argument is the data itself.
The other arguments are:

1. `cols`: The columns to use to convert to long form. The input is a vector
made using `c()` that contains the column names, like you would use in
`select()` (e.g. you can use the `select_helpers` like `starts_with()`, or `-`
minus to exclude).
1. `names_to`: Optional, the default is `name`. If provided, it will be the name of
the newly created column (as a quoted character) that contains the original
column names.
1. `values_to`: Optional, the default is `value`. Like `names_to`, sets the name of 
the new columns.

The `pivot_longer()` and its opposite `pivot_wider()`, that we will cover later
in the session, are both incredibly powerful functions. We can't show close to
everything it can do in this course, but if you want to learn more, read up on
the [documentation][tidyr-pivoting] for it.
**Ok, stop reading at this point and we will go over pivoting to long again.**

Let's try this out with `mmash`. In your `doc/lesson.Rmd` file, create a new
header called `## Pivot longer` and create a new code chunk below that. Now we can
start typing in our code:

```{r load-mmash, include=FALSE}
load(here("data/mmash.rda"))
```

```{r pivot-everything-error, error=TRUE}
mmash %>% 
    # pivot every column
    pivot_longer(everything())
```

This gives us an error because we are mixing data types. We can't have character
data and number data in the same column. Let's pivot only numbers.

```{r pivot-numeric}
mmash %>% 
    pivot_longer(where(is.numeric))
```

Nice! But not super useful. We can exclude specific columns from pivoting
with `-` before the column name, for instance with `user_id` and `day`. Let's
drop the `samples` column before pivoting since `day` gives us the same information:

```{r pivot-longer-example}
mmash %>% 
    select(-samples) %>% 
    pivot_longer(c(-user_id, -day, -gender))
```

## Exercise: Summarise your data after pivoting

Time: 15 min

Use `pivot_longer()` after the `group_by()` and `summarise()` we did previously:

Using the `group_by()` and `summarise()` functions we learned in 
section \@ref(summarise-with-functionals), complete these tasks starting from 
this code.

```{r, eval=FALSE}
mmash %>% 
    select(-samples) %>% 
    pivot_longer(c(-user_id, -day, -gender)) %>% 
    ___
```

1. Continuing the `%>%` from `pivot_longer()`, use `group_by()` to group the
data by `gender`, `day`, and `name` (the long form column produced from
`pivot_longer()`).
1. After grouping with `group_by()`, use `summarise()` and `across()` on the
`value` column and find the mean and standard deviation (put them into a named
list like we did previously). Don't forget to use `na.rm = TRUE` to exclude missing
values.
1. Stop the grouping effect with `ungroup()`.
1. Knit the R Markdown document into HTML (`Ctrl-Shift-K` or the "Knit" button).
1. Open up the Git interface and **add and commit** the changes to `doc/lesson.Rmd`.

```{r solution-pivot-summary, results='hide', solution=TRUE}
mmash %>% 
    select(-samples) %>% 
    pivot_longer(c(-user_id, -day, -gender)) %>% 
    group_by(gender, day, name) %>% 
    summarise(across(
        value,
        list(mean = mean, sd = sd), 
        na.rm = TRUE
    )) %>% 
    ungroup()
```

## Pivot data to wider form

`r details_for_instructors("
Like with the pivoting to long section, 
let them read through this section first and than go over it again to verbally
explain it more, making use of the graphs to help illustrate what is happening.
Doing both reading and listening will help reinforce the concepts.
")`

**Take 6 min to read over the sections until it says to stop, and then we'll 
go over it again.**

After using `pivot_longer()` on the summarised data, it looks nice, but it could
be better. Right now it is in a pretty long form, but for showing as a table,
having columns for either `gender` or `day` would make it easier to compare the 
mean and SD values we obtain. This is where we can use `pivot_wider()` to
get the data wider rather than long.
The arguments for `pivot_wider()` are very similar to those in `pivot_longer()`,
except instead of `names_to` and `values_to`, they are called 
`names_from` and `values_from`. Like with many R functions, the first argument
is the data and the other arguments are:

1. `id_cols`: This is optional as it will default to all column names. 
This argument tells `pivot_wider()` to use the given columns as the identifiers
for when converting. Unlike `pivot_longer()` which doesn't require some type of
"key" or "id" column to convert to long form, the conversion to wide form
requires some type of "key" or "id" column because `pivot_wider()` needs
to know which rows belong with each other.
1. `names_from`: Similar to the `pivot_longer()`, 
this is the name of the column that has the values that will make up the new
columns. Unlike with the `names_to` argument in `pivot_longer()` which takes a
character string as input, the column name for `names_from` must be *unquoted*
because you are selecting a column that already exists in the dataset.
1. `values_from`: Same as `names_from`, this is the column name (that exists and
must be given *unquoted*) for the values that will be in the new columns.

Figure \@ref(fig:image-pivot-wider) visually shows what's happening when using
`pivot_wider()`.

```{r image-pivot-wider, fig.cap="Pivot wider in tidyr.", out.width="90%", echo=FALSE}
knitr::include_graphics(here::here("images/pivot-wider.png"))
```

**Stop here and we will go over it again.**

In our case, we want either `gender` or `day` as columns with the mean and SD values. 
Let's use `pivot_wider()` on `day` to see differences between days.

```{r pivot-wider-from-summarised}
mmash %>% 
    select(-samples) %>% 
    pivot_longer(c(-user_id, -day, -gender)) %>% 
    group_by(gender, day, name) %>% 
    summarise(across(
        value,
        list(mean = mean, sd = sd), 
        na.rm = TRUE
    )) %>%
    ungroup() %>% 
    pivot_wider(names_from = day)
```

Hmm, didn't work. Nothing has been pivoted to wider. That's because we are missing 
the `value_from` argument. Since we actually have the two `value_mean`
and `value_sd` columns that have "values" in them, we need to tell `pivot_wider()`
to use those two columns. Since `values_from` works similar to `select()`,
we can use `starts_with()` to select the columns starting with `"values"`.

```{r pivot-wider-from-summarised-starts-with}
mmash %>% 
    select(-samples) %>% 
    pivot_longer(c(-user_id, -day, -gender)) %>% 
    group_by(gender, day, name) %>% 
    summarise(across(
        value,
        list(mean = mean, sd = sd), 
        na.rm = TRUE
    )) %>% 
    pivot_wider(names_from = day, values_from = starts_with("value"))
```

Now we have a different problem. There are missing values in both the `day` and `gender`
columns that, at least in this case, we don't want pivoted. We can remove
missing values with the function called `drop_na()`. Add it in the pipe
right before `group_by()`.

```{r pivot-wider-from-summarised-drop-na}
mmash %>% 
    select(-samples) %>% 
    pivot_longer(c(-user_id, -day, -gender)) %>% 
    drop_na(day, gender) %>% 
    group_by(gender, day, name) %>% 
    summarise(across(
        value,
        list(mean = mean, sd = sd), 
        na.rm = TRUE
    )) %>% 
    pivot_wider(names_from = day, values_from = starts_with("value"))
```

## Exercise: Convert this code into a function

Time: 15 min

Using the same workflow we've been doing throughout this course,
convert the code we just wrote above into a function.

1. Name the function `tidy_summarise_by_day`.
1. Create one argument called `data`.
1. Test that the function works.
1. Add Roxygen documentation and use explicit function calls with
`packagename::`.
    - Don't forget, you can use `?functionname` to find out which package the
    function comes from.
1. Move the newly created function over into the `R/functions.R` file.
1. Restart R, go into the `doc/lesson.Rmd` file and run the `setup` code chunk
in the R Markdown document with the `source()` and `load()` commands. Then test
that the new function works in a code chunk at the bottom of the document.

```{r solution-summarise-function, results='hide', solution=TRUE}
#' Calculate tidy summary statistics by day.
#'
#' @param data The MMASH dataset.
#'
#' @return A data.frame/tibble.
#'
tidy_summarise_by_day <- function(data) {
    data %>%
        dplyr::select(-samples) %>%
        tidyr::pivot_longer(c(-user_id, -day, -gender)) %>%
        tidyr::drop_na(day, gender) %>%
        dplyr::group_by(gender, day, name) %>%
        dplyr::summarise(dplyr::across(value,
                         list(mean = mean, sd = sd),
                         na.rm = TRUE)) %>%
        tidyr::pivot_wider(names_from = day, 
                    values_from = dplyr::starts_with("value"))
}
```

## Exercise: Extend the function to use other statistics and to be tidier

Time: 15 min

We've made the tidy summary code into a function, now let's make it so we can
choose which summary functions to use and to make the output a bit tidier.
These tasks will be *challenging*, so discuss and work with your group on
completing this exercise.

1. First thing, let's tidy up the output. Go into the `R/functions.R` script
to make these changes. Use the workflow of using `source()` and testing in the R
Markdown document. Right below the `tidyr::drop_na()` function do these tasks:
    - Just like how `summarise()` can combine with the `across()` functional to
    do actions on multiple columns, `mutate()` can also be paired with
    `across()`.
    - Use the `mutate()` and `across()` combination on columns that
    `start_with()` "value".
    - Within `across()`, use the `round()` function and set the `digits = 2`
    so the output gets rounded to less digits. For hints on how to do this,
    refer to the `summarise()` function right above it as well as in
    session \@ref(summarise-with-functionals).
    
2. Next, let's add a new argument to the function to allow us to use other
summary statistics instead of only `mean()` and `sd()`. Add a new argument to
the function and call it `summary_fn`. Try to figure out how to make the function
output the `median()` and `max()` instead. This task is intentionally a bit vague
to make it a challenge for you to figure this out. Use the below code as a
reference to how the function *should* look and work.

    ```r
    mmash %>% 
        tidy_summarise_by_day(median)
    mmash %>% 
        tidy_summarise_by_day(max)
    mmash %>% 
        tidy_summarise_by_day(list(median = median, max = max))
    ```

```{r solution-summary-extend, results='hide', solution=TRUE}
#' Calculate tidy summary statistics by day.
#'
#' @param data The MMASH dataset.
#'
#' @return A data.frame/tibble.
#'
tidy_summarise_by_day <- function(data, summary_fn) {
    data %>%
        dplyr::select(-samples) %>%
        tidyr::pivot_longer(c(-user_id, -day, -gender)) %>%
        tidyr::drop_na(day, gender) %>%
        dplyr::group_by(gender, day, name) %>%
        dplyr::summarise(dplyr::across(
            value,
            # Changed from task 2.
            summary_fn,
            na.rm = TRUE)
        ) %>%
        # Changed from task 1.
        dplyr::mutate(dplyr::across(dplyr::starts_with("value"), 
                                    round, digits = 2)) %>% 
        tidyr::pivot_wider(names_from = day, 
                    values_from = dplyr::starts_with("value"))
}

# This code would be in the `doc/lesson.Rmd` file.
mmash %>% 
    tidy_summarise_by_day(max)
mmash %>%
    tidy_summarise_by_day(median)
mmash %>%
    tidy_summarise_by_day(list(median = median, max = max))
```

## Making prettier output in R Markdown

`r details_for_instructors("
Can go over this quite quickly after they've (optionally) finished the previous
exercise.
")`

What we created is nice and all, but since we are working in an R Markdown
document and knitting to HTML, let's make it easier for others (including
yourself) to read the document. Let's make the output as an actual table.
We can do that with `knitr::kable()` (meaning "knitr table"). We can also
add a table caption with the `caption` argument.

```{r knitr-table}
mmash %>% 
    tidy_summarise_by_day(list(mean = mean, min = min, max = max)) %>% 
    knitr::kable(caption = "Descriptive statistics of some variables.")
```

Then knit the document and check out the HTML file. So pretty! `r emo::ji("grin")`
(well, there's lots of things to fix up, but its a good starting place.)

## General workflow up to this point {#general-workflow}

`r details_for_instructors("
You can go over this point verbally, reiterating what they've learned so far.
")`

You now have some skills and tools to allow you to reproducibly import,
process, clean, join, and eventually analyze your datasets.
Listed below are the general workflows we've covered and that you
can use as a guideline to complete the following (optional) exercises and group
work.

- Import with the `vroom()` to `spec()` to `vroom()` again.
- Convert importing into a function in an R Markdown document,
move to the `R/function.R` script, restarting R, and `source()`.
- Test that joining datasets into a final form works properly while in
an R Markdown document, then cut and paste the code into a data processing R
script in the `data-raw/` folder (optionally this can also be done in the 
`data-raw/` R script).
- Restart R and generate the `.rda` dataset in the `data/` folder by
sourcing the `data-raw/` R script.
- Restart R, load the new dataset with `load()` and put the loading code into an
R Markdown document.
- Add any additional cleaning code to the data processing R script in
`data-raw/` and update the `.rda` dataset in `data/` whenever you encounter
problems in the dataset.
- Write R in code chunks in an R Markdown document to further analyze your data
and check reproducibility by often knitting to HTML.
    - Part of this workflow is to also write R code to output in a way that
    looks nice in the HTML (or Word) formats by mostly creating tables or
    figures of the R output.
- Use Git often by adding and committing into the history so you never lose
stuff and can keep track of changes to your files.

## Exercise: Process and join sleep and questionnaire data

Time: 30 min

**This is an *optional* exercise and could also be done during the group work time.**

There are still a few datasets that you can join in with the current
datasets like `sleep.csv` and `questionnaire.csv`. 
Using the workflows in Section \@ref(general-workflow) as a guide,
start from the beginning and import, process, clean, make functions,
and join these two datasets in with the others so that they get 
included in the `data/mmash.rda` final dataset. Afterwards, do some
descriptive analysis using the function `tidy_summarise_by_day()`.

## Exercise: Create a second dataset of only the Actigraph and RR data

Time: 30 min

**This is an *optional* exercise and could also be done during the group work time.**

The Actigraph and RR datasets contain a lot of interesting and useful
data that gets destroyed when we first summarise and then join them
with the other datasets. While we can't meaningfully join all this
data with the other datasets, we can join them on their own as separate datasets.

Using the workflows in Section \@ref(general-workflow) as a guide,
start from the beginning and import, process, clean, make functions,
and create a final dataset of only the `Actigraph.csv` and `RR.csv`
datasets.

- Join only these two datasets by `user_id`, `day`, and `time`.
- Name the new dataset `actigraph_rr` and save it to `data/`
by using another `usethis::use_data()` line in the `data-raw/mmash.R`
script.
